# 파드

k8s에서 생성/관리하는 가장 작은 단위.

하나 이상의 컨테이너 그룹으로 구성되어 있으며, 컨테이너는 서로 스토리지와 네트워크를 공유한다.

## 파드란 무엇인가?

컨테이너는 다양한 런타임으로 구성할 수 있으며, 대표적으로 도커를 사용한다.

## 용법

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.14.2
    ports:
    - containerPort: 80
```

```shell
$ kubectl apply -f pod.yaml
```


### 워크로드 리소스

일반적으로 파드는 직접 생성하지 않고 워크로드 리소스(deployment, job 등)를 사용하여 생성한다.

또는 상태를 추적(stateful)해야 한다면, 스테이트풀셋(StatefulSet)을 사용한다.

1. 단일 컨테이너 파드

   파드 당 하나의 컨테이너를 구성하는 가장 일반적인 모델. 파드는 컨테이너를 둘러싼 Wrapper로 볼 수 있다.

2. 다중 컨테이너 파드

   리소스(스토리지, 네트워크)를 공유해야할 때 여러 개의 컨테이너로 구성하여 캡슐화할 수 있다.

결국 파드는 특정 애플리케이션의 단일 인스턴스를 실행하기 위한 것이다. 

수평적 확장을 위해선 파드안에 컨테이너를 늘리는 것이 아닌 파드를 늘리는 방법으로 확장한다.

이렇게 확장된 복제본(Replica)은 각 리소스 컨트롤러에 의해 관리된다.

### 파드가 여러 컨테이너를 관리하는 방법 

파드는 자체 리소스로서 여러 컨테이너(프로세스)를 지원한다.

예를 들어, 볼륨의 파일에 대한 웹 서버 역할을 하는 컨테이너와, 원격 소스에서 해당 파일을 업데이트하는 별도의 **사이드카** 컨테이너가 있을 수 있다.

뿐만 아니라 앱 컨테이너가 동작하기 전에 동작을 완료하는 초기화 컨테이너도 있을 수 있다.

결국 파드는 이런 컨테이너들에게 불륨(스토리지)과 네트워크를 제공한다.

## 파드 작업

파드는 상대적으로 일시적인 오브젝트로 사용되기 때문에 사용자가 직접 개별파드를 생성하는 경우는 거의 없다.

파드는 파드 실행이 완료되거나, 파드 오브젝트가 삭제되거나, 리소스 부족으로 인해 파드가 축출 되거나, 노드가 실패할 때까지 생성된 노드에 남아있다.

파드는 프로세스가 아니라 컨테이너를 실행하기 위한 환경이다. 따라서 파드 재실행이 컨테이너 재실행을 의미하는 것이 아니다.

### 파드와 컨트롤러

워크로드 리소스를 사용하여 여러 파드를 만들고 관리할 수 있다. 리소스 컨트롤러는 파드 장애 시 복제 및 롤아웃과 자동 복구를 처리한다.

1. 디플로이먼트

2. 스테이트풀셋

3. 데몬셋(DaemonSet)

### 파드 템플릿 

각 리소스 컨트롤러는 파드 템플릿을 이용하여 파드를 생성하고 이를 관리한다.

생성되는 파드의 명세를 정의하는 것을 파드 템플릿이라고 한다.

파드를 생성하는 모든 컨트롤러에는 `template` 필드가 존재하며, 이하에 파드 명세를 정의한다.

파드 템플릿을 수정하더라고 기존에 존재하는 파드에는 영향을 주지 않는다.

## 리소스 공유와 통신 

파드는 파든 내부느의 컨테이너간 데이터 공유와 통신을 지원한다.

### 파드 스토리지 

파드는 공유 스토리지 볼륨의 집합을 지정할 수 있다. 

파드의 모든 컨테이너는 공유 볼륨에 접근할 수 있으므로, 해당 컨테이너가 데이터를 공유할 수 있다. 

### 파드 네트워킹 

파드가 생성되는 각 파드에는 고유한 IP가 할당된다.

파드의 모든 컨테이너는 네트워크 네임스페이스를 공유하며, 이는 IP와 포트를 포함된다.

파드 내부의 컨테이너간 통신은 localhost를 이용하여 가능하며, 다른 파드와의 통신은 위에 할당된 IP를 이용하여 가능하다.

## 정적(Static) 파드 

스태틱파드는 kube-apiserver가 아닌 kubelet데몬이 직접 관리하는 파드이다.

대부분의 파드는 리소스 컨트롤러를 통해 관리되지만 스태틱파드는 kubelet이 라이프사이클을 관리한다.

kubelet은 스태틱파드를 생성하는 동시에 apiserver에 미러파드를 생성한다. 때문에 api서버에서는 파드가 보이지만

이를 제어할 수는 없다.

## 컨테이너 프로브 

**프로브**는 컨테이너의 kubelet에 의해 주기적으로 실행되는 진단이다. 진단을 위해 아래와 같은 작업을 호출한다.

1. ExecAction (컨테이너 런타임의 도움을 받아 수행)

2. TCPSocketAction (kubelet에 의해 직접 검사)

3. HTTPGetAction (kubelet에 의해 직접 검사)


